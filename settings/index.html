<!DOCTYPE html>
<html>
  <head>
    <!-- The '/homey.js' script must be included in your settings view to work -->
    <script
      type="text/javascript"
      src="/homey.js"
      data-origin="settings"
    ></script>
  </head>
  <body>
    <h1 data-i18n="settings.title">
      <!--
            This field will automatically be filled by a translated string with key 'settings.title'.
            Read more about translations at Internationalization.
            -->
    </h1>

    <fieldset>
      <legend>HDL Smartbus settings</legend>
      <div class="field row">
        <label for="hdl_ip_address">IP address</label>
        <input id="hdl_ip_address" type="text" value="" />
      </div>
      <div class="field row">
        <label for="hdl_subnet">Subnet (in HDL, 1-255)</label>
        <input id="hdl_subnet" type="text" value="" />
      </div>
    </fieldset>

    <fieldset>
      <legend>Motion Sensor Universal Switch</legend>
      <p>
        To catch motion and no motion from a motion sensor, you need create
        logic that sends a universal switch broadcast with true if motion and
        false if no motion. The default universal switch number is 212. Change
        it here if you need to.
      </p>
      <div class="field row">
        <label for="hdl_universal_motion">
          Universal Switch Number (1-254)
        </label>
        <input id="hdl_universal_motion" type="text" value="" />
      </div>
    </fieldset>

    <button id="save" class="right">Save changes</button>

    <script type="text/javascript">
      function onHomeyReady(Homey) {
        var ipElement = document.getElementById("hdl_ip_address");
        var subnetElement = document.getElementById("hdl_subnet");
        var motionElement = document.getElementById("hdl_universal_motion");
        var saveElement = document.getElementById("save");

        Homey.get("hdl_ip_address", function(err, hdl_ip_address) {
          if (err) return Homey.alert(err);
          ipElement.value = hdl_ip_address;
        });

        Homey.get("hdl_subnet", function(err, hdl_subnet) {
          if (err) return Homey.alert(err);
          subnetElement.value = hdl_subnet;
        });

        Homey.get("hdl_universal_motion", function(err, hdl_universal_motion) {
          if (err) return Homey.alert(err);
          motionElement.value = hdl_universal_motion;
        });

        saveElement.addEventListener("click", function(e) {
          const ipRegex = /^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$/g;
          const subnetRegex = /^\d{1,3}$/g;

          // Verify IP-address
          if (!ipElement.value.match(ipRegex))
            return Homey.alert("Not a valid IP address");

          // Verify subnet
          if (!subnetElement.value.match(subnetRegex)) {
            return Homey.alert(
              "Not a valid HDL Subnet (not up to 3 numbers). Please use 1-254 (usually 1)"
            );
          }

          let subnet = parseInt(subnetElement.value);
          if (subnet < 1) {
            return Homey.alert(
              "Not a valid HDL Subnet (less than 0). Please use 1-254 (usually 1)"
            );
          }

          if (subnet > 254) {
            return Homey.alert(
              `Not a valid HDL Subnet (more than 254 - ${subnet}). Please use 1-254 (usually 1)`
            );
          }

          // Verify motion universal switch number
          if (!motionElement.value.match(subnetRegex)) {
            return Homey.alert(
              "Not a valid Universal Switch Number. Please use 1-254"
            );
          }

          let motion = parseInt(motionElement.value);
          if (motion < 1) {
            return Homey.alert(
              "Not a valid Universal Switch Number. Please use 1-254 "
            );
          }

          if (motion > 254) {
            return Homey.alert(
              "Not a valid Universal Switch Number. Please use 1-254"
            );
          }

          Homey.set("hdl_ip_address", ipElement.value, function(err) {
            if (err) return Homey.alert(err);
          });

          Homey.set("hdl_subnet", subnetElement.value, function(err) {
            if (err) return Homey.alert(err);
          });

          Homey.set("hdl_universal_motion", subnetElement.value, function(err) {
            if (err) return Homey.alert(err);
          });

          Homey.alert(
            "Settings saved. You need to restart the app to connect the bus (or restart your Homey)"
          );
        });

        Homey.ready();
      }
    </script>
  </body>
</html>
